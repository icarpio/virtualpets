
{% extends "pets/base.html" %}

{% block title %}Detalle {{ pet.name }}{% endblock %}
{% block head_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
{% endblock %}

{% block styles %}
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
    }
    .mascota-detalle {
        margin-top: 20px;
    }
    .mascota-detalle img {
        width: 100%;
        max-width: 150px;
        height: auto;
        object-fit: cover;
    }
    .valores {
        font-size: 16px;
        margin-top: 20px;
    }
    #game-container {
        width: 100%;
        max-width: 600px;
        height: auto;
        aspect-ratio: 3 / 2;
        margin: 20px auto;
    }
    @media (max-width: 768px) {
        #game-container {
            max-width: 100%;
        }
    }
</style>
{% endblock %}
{% block content %}
<h1 class="text-center">Detalles de {{ pet.name }}</h1>

<!-- Contenedor para Phaser.js -->
<div id="phaser-container"></div>
<script>
    var evo = {{pet.evolution_stage}}
    var petId = {{ pet.id }};  // ID de la mascota
    var petImageUrl = "{{ pet.current_image}}";

   
    
    // Phaser.js game configuration
    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        parent: 'phaser-container',  // Este es el contenedor donde se renderiza el juego
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var petImage;
    var petName = "{{ pet.name }}";
    var hunger = {{ pet.hunger }};
    var energy = {{ pet.energy }};
    var happiness = {{ pet.happiness }};

    var hungerButton, energyButton, happinessButton;
    var hungerIcon, energyIcon, happinessIcon;

    var game = new Phaser.Game(config);

    function preload() {
        // Cargar la imagen de la mascota usando la URL pasada desde Django
        if (!petImageUrl) {
            console.error('La URL de la imagen es inválida');
        } else {
            this.load.image('background', '/static/images/part3.png')
            var proxyUrl = "/pets/image-proxy/" + encodeURIComponent(petImageUrl);
            this.load.image('pet', proxyUrl);  // Usar el proxy para cargar la imagen
        }
        this.load.image('hungerButton', '/static/images/food.png');  
        this.load.image('energyButton', '/static/images/energy.png');
        this.load.image('happinessButton', '/static/images/smile.png');

        this.load.image('hungerIcon', '/static/images/food.png');  
        this.load.image('energyIcon', '/static/images/energy.png');
        this.load.image('happinessIcon', '/static/images/smile.png');
        
    }
        

    function create() {
        this.add.image(400, 300, 'background').setScale(1.5);
        // Mostrar la imagen de la mascota
        petImage = this.add.image(400, 300, 'pet');  // Posición inicial de la mascota
        hungerIcon = this.add.image(700, 100, 'hungerIcon'); 
        energyIcon = this.add.image(700, 160, 'energyIcon'); 
        happinessIcon = this.add.image(700, 220, 'happinessIcon'); 
       
        this.add.text(35, 40, "Mascota: " + petName, { font: "24px Arial", fill: "#ffffff" });

        

        // Botón de hambre con imagen
        hungerButton = this.add.image(50, 100, 'hungerButton')  // 'hungerIcon' es la clave de la imagen
            .setInteractive()
            .on('pointerdown', function() {
                increaseParameter('hunger', hunger);
            });

        // Botón de energía con imagen
        energyButton = this.add.image(50, 160, 'energyButton')
            .setInteractive()
            .on('pointerdown', function() {
                increaseParameter('energy', energy);
            });

        // Botón de felicidad con imagen
        happinessButton = this.add.image(50, 220, 'happinessButton')
            .setInteractive()
            .on('pointerdown', function() {
                increaseParameter('happiness', happiness);
            });

        // Agregar texto al lado de los botones para mostrar valores
        hungerText = this.add.text(80, 90, 'Hambre: 0', { font: '20px Arial', fill: '#ffffff' });
        energyText = this.add.text(80, 150, 'Energía: 0', { font: '20px Arial', fill: '#ffffff' });
        happinessText = this.add.text(80, 210, 'Felicidad: 0', { font: '20px Arial', fill: '#ffffff' });

        // Ajustar el tamaño de los botones si es necesario
        hungerButton.setScale(0.3);  // Escala la imagen al 50%
        energyButton.setScale(0.3);
        happinessButton.setScale(0.3);
        petImage.setScale(1.5);
        hungerIcon.setScale(0.3);
        energyIcon.setScale(0.3);
        happinessIcon.setScale(0.3);
}

    function update() {
            // Actualiza los valores de los textos, ya que las imágenes no pueden cambiar texto
            hungerText.setText('Hambre: ' + hunger);
            energyText.setText('Energía: ' + energy);
            happinessText.setText('Felicidad: ' + happiness);
    }

    function increaseParameter(param, currentValue) {
        var url = '';

        // Determinar qué parámetro estamos actualizando
        if (param === 'hunger') {
            url = `/pets/increase_hunger/${petId}/`;  // La URL debería coincidir con la definida en Django
        } else if (param === 'energy') {
            url = `/pets/increase_energy/${petId}/`;
        } else if (param === 'happiness') {
            url = `/pets/increase_happiness/${petId}/`;
        }

        // Enviar la solicitud AJAX para aumentar el parámetro
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',  // Asegúrate de que el CSRF token esté presente
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Actualizar el valor local del parámetro
            if (param === 'hunger') {
                hunger = data.hunger;
            } else if (param === 'energy') {
                energy = data.energy;
            } else if (param === 'happiness') {
                happiness = data.happiness;
            }
        })
        .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
        });
    }
</script>
<a href="{% url 'pet_dashboard' %}" class="btn btn-primary">Mis mascotas</a>

{% endblock %}